@using System.Globalization
@using DinaZen.Components.Gantt.Models
@using System.Net.Http

@using Microsoft.AspNetCore.Components.Web


@if (Viewport.IsNull())
	return;


<div class="gantt-header">

	<!-- 📅 Navigation Section -->
	<div class="nav-section">
		<div class="nav-controls">
			<button type="button" class="nav-btn" @onclick="Prev">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
					<path d="M15 18l-6-6 6-6" />
				</svg>
			</button>
			<button type="button" class="nav-btn" @onclick="Next">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
					<path d="M9 18l6-6-6-6" />
				</svg>
			</button>
		</div>

		<div class="title-container">
			<span class="title-label">@GetTitleLabel()</span>
			<span class="title-main">@GetTitle()</span>
		</div>

		<button type="button" class="today-btn" @onclick="Today">
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
				<line x1="16" y1="2" x2="16" y2="6" />
				<line x1="8" y1="2" x2="8" y2="6" />
				<line x1="3" y1="10" x2="21" y2="10" />
			</svg>
			<span>Hoy</span>
			<span class="today-indicator"></span>
		</button>
	</div>

	<!-- 🎛️ View Modes Section -->
	<div class="modes-section">
		<span class="modes-label">Vista</span>
		<div class="modes-container">
			@foreach (var mode in Modes)
			{
				<button type="button" class=@($"mode-btn {(mode == Viewport.ViewMode ? "active" : "")}") @onclick="() => SetMode(mode)" title="@GetModeText(mode)">
					@GetModeIcon(mode)
					<span>@GetModeText(mode)</span>
				</button>
			}
		</div>
	</div>

	<!-- 🔍 Zoom Section -->
	<div class="zoom-section">
		<span class="zoom-label">Zoom</span>
		<div class="zoom-container">
			<button type="button" class="zoom-btn" @onclick="ZoomOut" title="Reducir zoom">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<circle cx="11" cy="11" r="8" />
					<line x1="21" y1="21" x2="16.65" y2="16.65" />
					<line x1="8" y1="11" x2="14" y2="11" />
				</svg>
			</button>
			<div class="zoom-display">
				<span class="zoom-value">@Viewport.Zoom%</span>
				<div class="zoom-slider-container">
					<div class="zoom-slider-fill" style="width: @(((Viewport.Zoom - 25) / 3.75))%"></div>
				</div>
			</div>
			<button type="button" class="zoom-btn" @onclick="ZoomIn" title="Aumentar zoom">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<circle cx="11" cy="11" r="8" />
					<line x1="21" y1="21" x2="16.65" y2="16.65" />
					<line x1="11" y1="8" x2="11" y2="14" />
					<line x1="8" y1="11" x2="14" y2="11" />
				</svg>
			</button>
		</div>
	</div>

</div>


@code
{
	[Parameter, EditorRequired]
	public GanttViewport Viewport { get; set; } = default!;

	[Parameter]
	public EventCallback<GanttViewport> ViewportChanged { get; set; }

	protected IReadOnlyList<GanttViewMode> Modes => new[]
	{
		GanttViewMode.Hour,
		GanttViewMode.Week,
		GanttViewMode.Month,
		GanttViewMode.Year
	};

	private Task Prev() => UpdateViewport(vp =>
	{
		vp.FocusDate = vp.ViewMode switch { GanttViewMode.Hour => vp.FocusDate.AddDays(-1), GanttViewMode.Week => vp.FocusDate.AddDays(-7), GanttViewMode.Month => vp.FocusDate.AddMonths(-1), GanttViewMode.Year => vp.FocusDate.AddYears(-1), _ => vp.FocusDate };
	});

	private Task Next() => UpdateViewport(vp =>
	{
		vp.FocusDate = vp.ViewMode switch { GanttViewMode.Hour => vp.FocusDate.AddDays(1), GanttViewMode.Week => vp.FocusDate.AddDays(7), GanttViewMode.Month => vp.FocusDate.AddMonths(1), GanttViewMode.Year => vp.FocusDate.AddYears(1), _ => vp.FocusDate };
	});

	private Task Today() => UpdateViewport(vp => vp.FocusDate = DateTime.Today);

	private Task SetMode(GanttViewMode mode) => UpdateViewport(vp => vp.ViewMode = mode);

	private Task ZoomIn() => UpdateViewport(vp => vp.Zoom = Math.Min(400, vp.Zoom + 25));

	private Task ZoomOut() => UpdateViewport(vp => vp.Zoom = Math.Max(25, vp.Zoom - 25));

	private Task UpdateViewport(Action<GanttViewport> mutate)
	{
		// Creamos una copia para que el cambio sea "observable" (y evitar mutar el objeto del padre).
		var vp = Viewport is null
			? new GanttViewport()
			: new GanttViewport
			{
				FocusDate = Viewport.FocusDate,
				ViewMode = Viewport.ViewMode,
				Zoom = Viewport.Zoom
			};

		mutate(vp);

		Viewport = vp;
		return ViewportChanged.InvokeAsync(vp);
	}

	private string GetTitleLabel() => Viewport.ViewMode switch
	{
		GanttViewMode.Hour => "Fecha",
		GanttViewMode.Week => "Período",
		GanttViewMode.Month => "Mes",
		GanttViewMode.Year => "Año",
		_ => ""
	};

	private string GetTitle() => Viewport.ViewMode switch
	{
		GanttViewMode.Hour => Viewport.FocusDate.ToString("dddd, dd MMMM yyyy", new CultureInfo("es-ES")),
		GanttViewMode.Week => $"Semana {ISOWeek.GetWeekOfYear(Viewport.FocusDate)} · {Viewport.FocusDate:yyyy}",
		GanttViewMode.Month => Viewport.FocusDate.ToString("MMMM yyyy", new CultureInfo("es-ES")),
		GanttViewMode.Year => Viewport.FocusDate.Year.STR(),
		_ => ""
	};

	private static string GetModeText(GanttViewMode mode) => mode switch
	{
		GanttViewMode.Hour => "Horas",
		GanttViewMode.Week => "Semana",
		GanttViewMode.Month => "Mes",
		GanttViewMode.Year => "Año",
		_ => ""
	};

	private static RenderFragment GetModeIcon(GanttViewMode mode) => mode switch
	{
	GanttViewMode.Hour => @<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<circle cx="12" cy="12" r="10" />
			<polyline points="12 6 12 12 16 14" />
		</svg>,
		GanttViewMode.Week => @<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<rect x="3" y="4" width="18" height="18" rx="2" />
			<line x1="3" y1="10" x2="21" y2="10" />
			<line x1="9" y1="4" x2="9" y2="22" />
			<line x1="15" y1="4" x2="15" y2="22" />
		</svg>,
		GanttViewMode.Month => @<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
			<rect x="3" y="4" width="18" height="18" rx="2" />
			<line x1="16" y1="2" x2="16" y2="6" />
			<line x1="8" y1="2" x2="8" y2="6" />
			<line x1="3" y1="10" x2="21" y2="10" />
		</svg>,
		GanttViewMode.Year => @<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<rect x="3" y="4" width="18" height="18" rx="2" />
				<path d="M3 10h18M8 14h.01M12 14h.01M16 14h.01M8 18h.01M12 18h.01M16 18h.01" />
			</svg>,
			_ => @<span></span>
			};
		}