@* DateTimeRangeSelector - DateTime range picker with predefined options *@
@using System.ComponentModel.DataAnnotations

<div class="d-flex gap-2 align-items-center flex-wrap">

	<RadzenFormField Text="Range" Variant="Variant.Flat" class="min-w-[240px]">
		<EnumDropDown TEnum="DateTimeRangePreset" @bind-Value="SelectedPreset" @bind-Value:after="OnPresetChanged" Style="width: 100%;" />
	</RadzenFormField>

	@if (SelectedPreset == DateTimeRangePreset.Custom)
	{
		<div class="d-flex gap-3 justify-content-start w-100">
			<RadzenFormField Text="From" class="flex-grow-1" Variant="Variant.Flat">
				<RadzenDatePicker TValue="DateTime?"
								  Value="@_from"
								  DateFormat="dd/MM/yyyy HH:mm"
								  ShowTime="true"
								  Change="@OnFromChanged" />
			</RadzenFormField>
			<RadzenFormField Text="To" class="flex-grow-1" Variant="Variant.Flat">
				<RadzenDatePicker TValue="DateTime?"
								  Value="@_to"
								  DateFormat="dd/MM/yyyy HH:mm"
								  ShowTime="true"
								  Change="@OnToChanged" />
			</RadzenFormField>
		</div>
	}
</div>

@code {
	[Parameter] public EventCallback<(DateTime From, DateTime To)> OnRangeChanged { get; set; }
	[Parameter] public DateTimeRangePreset SelectedPreset { get; set; } = DateTimeRangePreset.Last7Days;
	[Parameter] public EventCallback<DateTimeRangePreset> SelectedPresetChanged { get; set; }

	private DateTime? _from;
	private DateTime? _to;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		await base.OnAfterRenderAsync(firstRender);

		if (firstRender)
			await OnPresetChanged();
	}

	private async Task OnPresetChanged()
	{
		if (SelectedPreset == DateTimeRangePreset.Custom)
		{
			await SelectedPresetChanged.InvokeAsync(SelectedPreset);
			return;
		}

		await SetPreset(SelectedPreset);
	}

	private async Task SetPreset(DateTimeRangePreset preset)
	{
		var today = DateTime.Today;

		switch (preset)
		{
			case DateTimeRangePreset.Today:
				_from = today;
				_to = today.AddDays(1).AddTicks(-1);
				break;

			case DateTimeRangePreset.Yesterday:
				var yesterday = today.AddDays(-1);
				_from = yesterday;
				_to = today.AddTicks(-1);
				break;

			case DateTimeRangePreset.Last7Days:
				_from = today.AddDays(-6);
				_to = today.AddDays(1).AddTicks(-1);
				break;

			case DateTimeRangePreset.Last30Days:
				_from = today.AddDays(-29);
				_to = today.AddDays(1).AddTicks(-1);
				break;

			case DateTimeRangePreset.ThisMonth:
				_from = new DateTime(today.Year, today.Month, 1);
				_to = new DateTime(today.Year, today.Month, DateTime.DaysInMonth(today.Year, today.Month), 23, 59, 59);
				break;

			case DateTimeRangePreset.LastMonth:
				var lastMonth = today.AddMonths(-1);
				_from = new DateTime(lastMonth.Year, lastMonth.Month, 1);
				_to = new DateTime(lastMonth.Year, lastMonth.Month, DateTime.DaysInMonth(lastMonth.Year, lastMonth.Month), 23, 59, 59);
				break;

			case DateTimeRangePreset.ThisQuarter:
				var quarterStart = GetQuarterStart(today);
				_from = quarterStart;
				_to = quarterStart.AddMonths(3).AddTicks(-1);
				break;

			case DateTimeRangePreset.LastQuarter:
				var lastQuarterStart = GetQuarterStart(today).AddMonths(-3);
				_from = lastQuarterStart;
				_to = lastQuarterStart.AddMonths(3).AddTicks(-1);
				break;

			case DateTimeRangePreset.ThisYear:
				_from = new DateTime(today.Year, 1, 1);
				_to = new DateTime(today.Year, 12, 31, 23, 59, 59);
				break;

			case DateTimeRangePreset.LastYear:
				_from = new DateTime(today.Year - 1, 1, 1);
				_to = new DateTime(today.Year - 1, 12, 31, 23, 59, 59);
				break;

			case DateTimeRangePreset.Custom:
			default:
				break;
		}

		SelectedPreset = preset;
		await SelectedPresetChanged.InvokeAsync(SelectedPreset);

		if (_from.HasValue && _to.HasValue)
			await OnRangeChanged.InvokeAsync((_from.Value, _to.Value));

		StateHasChanged();
	}

	private async Task OnFromChanged(DateTime? value)
	{
		_from = value;
		if (_from.HasValue && _to.HasValue)
			await OnRangeChanged.InvokeAsync((_from.Value, _to.Value));
	}

	private async Task OnToChanged(DateTime? value)
	{
		_to = value;
		if (SelectedPreset != DateTimeRangePreset.Custom)
		{
			SelectedPreset = DateTimeRangePreset.Custom;
			await SelectedPresetChanged.InvokeAsync(SelectedPreset);
		}

		if (_from.HasValue && _to.HasValue)
			await OnRangeChanged.InvokeAsync((_from.Value, _to.Value));
	}

	private static DateTime GetQuarterStart(DateTime date)
	{
		var quarter = (date.Month - 1) / 3;
		return new DateTime(date.Year, quarter * 3 + 1, 1);
	}

	public enum DateTimeRangePreset
	{
		[Display(Name = "Today")]
		Today,
		[Display(Name = "Yesterday")]
		Yesterday,
		[Display(Name = "Last 7 days")]
		Last7Days,
		[Display(Name = "Last 30 days")]
		Last30Days,
		[Display(Name = "This month")]
		ThisMonth,
		[Display(Name = "Last month")]
		LastMonth,
		[Display(Name = "This quarter")]
		ThisQuarter,
		[Display(Name = "Last quarter")]
		LastQuarter,
		[Display(Name = "This year")]
		ThisYear,
		[Display(Name = "Last year")]
		LastYear,
		[Display(Name = "Custom")]
		Custom
	}
}
